<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é¡”ã«èŠ‹ã‚’è²¼ã‚‹AI</title>
<style>
  body,main {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    background: #f4f4f4;
  }
  body {
    min-height: 95vh;
    display: flex;
    flex-direction: column;
  }
  main{
    flex:1;
    padding: 2rem;
  }
  canvas {
    border: 1px solid #aaa;
    border-radius: 8px;
    max-width: 90vw;
  }
  #controls {
    display: flex;
    gap: 1rem;
  }
  button {
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    background: #0078d7;
    color: white;
    cursor: pointer;
  }
  button:disabled {
    background: #999;
    cursor: not-allowed;
  }
  /* HTML: <div class="loader"></div> */
  .loader {
    width: 50px;
    aspect-ratio: 1;
    border-radius: 50%;
    border: 8px solid;
    border-color: #000 #0000;
    animation: l1 1s infinite;
  }
  @keyframes l1 {to{transform: rotate(.5turn)}}
</style>
<!-- tensorflowã¨blazefaceã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ  é †ç•ªã‚’å¤‰ãˆãªã„ã“ã¨ -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script> 
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
</head>
<body>
  <main>
    <div class="loader"></div>
    <p2 class="loadText">ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ä¸­</p2>
    <h2>é¡”ã«èŠ‹ã‚’è²¼ã‚Šä»˜ã‘ã‚ˆã†</h2>

    <input type="file" id="fileInput" accept="image/*">
    <canvas id="canvas" style="max-height: 90vh;"></canvas>

    <div id="controls">
      <button id="processBtn" disabled>é¡”æ¤œå‡ºï¼‹åˆæˆ</button>
      <button id="downloadBtn" disabled>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  </main>

  <script>
    const fileInput = document.getElementById("fileInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const processBtn = document.getElementById("processBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const loadingCss = document.getElementsByClassName("loader")[0];
    const loadingText = document.getElementsByClassName("loadText")[0];

    let image = new Image();
    let model;
    let overlayImage;

    // ğŸ”¹ ãƒ¢ãƒ‡ãƒ«ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã‚’äº‹å‰ã«ãƒ­ãƒ¼ãƒ‰
    async function init() {
      console.log("ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...");
      model = await blazeface.load(); // è‡ªå‹•ã§è»½é‡ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€
      overlayImage = await loadOverlayImage("imo.png");
      console.log("ãƒ¢ãƒ‡ãƒ«ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†");
      loadingCss.style = "display:none;";
      loadingText.style = "display:none;";
    }

    // ğŸ”¹ overlayç”»åƒã‚’éåŒæœŸãƒ­ãƒ¼ãƒ‰
    async function loadOverlayImage(url) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      return new Promise((resolve, reject) => {
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    // ğŸ”¹ ç”»åƒé¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        image.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    // ğŸ”¹ ç”»åƒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰Canvasã«æç”»
    image.onload = () => {
      canvas.width = image.width;
      canvas.height = image.height;
      ctx.drawImage(image, 0, 0);
      processBtn.disabled = false;
    };

    // ğŸ”¹ é¡”æ¤œå‡ºï¼‹åˆæˆå‡¦ç†
    processBtn.addEventListener("click", async () => {
    if (!model || !overlayImage) return;
    loadingCss.style = "";
    loadingText.style = "";
    loadingText.innerHTML = "ç”»åƒã‚’å‡¦ç†ä¸­";
    const predictions = await model.estimateFaces(image, false);
    // å…ƒç”»åƒã‚’å†æç”»
    ctx.drawImage(image, 0, 0);
    console.log(predictions);

    predictions.forEach(pred => {
        const [x_start, y_start] = pred.topLeft;
        const [x_end, y_end] = pred.bottomRight;

        // æ¤œå‡ºã•ã‚ŒãŸå¹…ã¨é«˜ã•
        const w_orig = x_end - x_start;
        const h_orig = y_end - y_start;
        
        // ----------------------------------------------------
        // âœ¨ èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯ âœ¨
        // ----------------------------------------------------
        
        // 1. ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆæ‹¡å¤§ï¼‰ã‚’è¨­å®š
        // å¹…ã‚’ç´„20%æ‹¡å¤§ã™ã‚‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        const W_PADDING_RATIO = 0.30; 
        const H_PADDING_RATIO = 0.40; // ç¸¦ã¯ã‚‚ã£ã¨å¤§ããæ‹¡å¤§ã—ã€ä¸Šã«ãšã‚‰ã™
        
        // æ‹¡å¤§å¾Œã®æ–°ã—ã„å¹…
        const w_new = w_orig * (1 + W_PADDING_RATIO);
        // æ‹¡å¤§å¾Œã®æ–°ã—ã„é«˜ã•
        const h_new = h_orig * (1 + H_PADDING_RATIO); 

        // 2. æ–°ã—ã„æç”»é–‹å§‹ä½ç½®ã®è¨ˆç®—
        // xåº§æ¨™ã‚’ä¸­å¤®å¯„ã›ã§èª¿æ•´
        const x_new = x_start - (w_new - w_orig) / 2;
        // yåº§æ¨™ã‚’ä¸Šã«èª¿æ•´ (ä¾‹: æ¤œå‡ºã•ã‚ŒãŸé–‹å§‹ä½ç½®ã‹ã‚‰ä¸Šã«10%ãšã‚‰ã™)
        // ğŸ’¡ BlazeFaceã¯é¼»ã®ã‚ãŸã‚Šã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã€ä¸Šã«å¤§ãããƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…è¦ã§ã™
        const y_new = y_start - h_orig * 0.3; // æ¤œå‡ºé«˜ã•ã®15%åˆ†ä¸Šã«ç§»å‹•ã•ã›ã‚‹

        // 3. æç”»
        // æ–°ã—ã„ä½ç½®ã¨ã‚µã‚¤ã‚ºã§åˆæˆç”»åƒã‚’drawImage
        ctx.drawImage(overlayImage, x_new, y_new, w_new, h_new);
    });
    loadingCss.style = "display:none;";
    loadingText.style = "display:none;";

    downloadBtn.disabled = false;
    });

    // ğŸ”¹ åŠ å·¥ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    downloadBtn.addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "processed.png";
      a.click();
    });

    window.onload = init; // èµ·å‹•æ™‚ã«ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰
  </script>
  <footer style="width: 100%;">
    <hr>
    <p style="text-align: center;color: #777;">Â© 2025 PotatoTimeKun<br>å¸¸è­˜ã®ç¯„å›²å†…ã§ãŠä½¿ã„ãã ã•ã„ã€‚<br>MIT Licence</p>
  </footer>
</body>
</html>
